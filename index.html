<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ SBER (EMA + MACD)</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 700px; margin: 20px auto; padding: 10px; }
  button { margin-right: 10px; padding: 7px 14px; cursor: pointer; }
  input { width: 70px; padding: 5px; margin-right: 10px; }
  #status { margin: 15px 0; font-weight: bold; }
  #results { white-space: pre-wrap; background: #f9f9f9; padding: 15px; border-radius: 6px; min-height: 200px; }
</style>
</head>
<body>

<h2>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ SBER (EMA + MACD)</h2>

<div>
  <button onclick="selectInterval('60')">–ß–∞—Å–æ–≤–æ–π</button>
  <button onclick="selectInterval('24')">–î–Ω–µ–≤–Ω–æ–π</button>
</div>

<div style="margin-top:15px;">
  <label>–ö–æ–º–∏—Å—Å–∏—è %: <input type="number" id="commission" step="0.01" value="0.1"></label>
  <label>–ú–∏–Ω. –ø—Ä–∏–±—ã–ª—å %: <input type="number" id="minProfit" step="0.01" value="0.3"></label>
  <button onclick="runAnalysis()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
</div>

<p id="status">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑"</p>

<div id="results"></div>

<script>
let interval = '24'; // –¥–Ω–µ–≤–Ω–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
let candlesByTicker = {};
let tickers = ['SBER', 'GAZP', 'LKOH']; // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –ª—é–±—ã–µ

function selectInterval(val) {
  interval = val;
  document.getElementById('status').textContent = `–í—ã–±—Ä–∞–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª: ${interval === '24' ? '–î–Ω–µ–≤–Ω–æ–π' : '–ß–∞—Å–æ–≤–æ–π'}`;
  document.getElementById('results').textContent = '';
}

// –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –æ–¥–Ω–æ–π –∞–∫—Ü–∏–∏
async function fetchDataForTicker(ticker) {
  let candles = [];
  const years = [2022, 2023, 2024, 2025];
  for (const year of years) {
    const from = `${year}-01-01`;
    const till = `${year}-12-31`;
    const url = `https://iss.moex.com/iss/engines/stock/markets/shares/boards/TQBR/securities/${ticker}/candles.json?interval=${interval}&from=${from}&till=${till}&limit=1000`;
    try {
      const res = await fetch(url);
      const json = await res.json();
      if (!json.candles || !json.candles.data) continue;
      const cols = json.candles.columns;
      const data = json.candles.data;
      const dateIdx = cols.indexOf('begin');
      const openIdx = cols.indexOf('open');
      const highIdx = cols.indexOf('high');
      const lowIdx = cols.indexOf('low');
      const closeIdx = cols.indexOf('close');
      const volumeIdx = cols.indexOf('volume');

      const yearData = data.map(row => ({
        date: new Date(row[dateIdx]),
        open: row[openIdx],
        high: row[highIdx],
        low: row[lowIdx],
        close: row[closeIdx],
        volume: row[volumeIdx]
      }));
      candles = candles.concat(yearData);
    } catch(e) {
      console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${ticker}:`, e);
    }
  }
  candlesByTicker[ticker] = candles;
}

// –ê–Ω–∞–ª–∏–∑ –ø–æ –≤—Å–µ–º –∞–∫—Ü–∏—è–º
async function runAnalysis() {
  document.getElementById('status').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
  document.getElementById('results').textContent = '';
  candlesByTicker = {};

  for (const ticker of tickers) {
    await fetchDataForTicker(ticker);
    const data = candlesByTicker[ticker];
    if (!data || data.length === 0) continue;

    const emaShort = calculateEMA(data, 5);
    const emaLong = calculateEMA(data, 15);
    const {macdLine, signalLine} = calculateMACD(data);
    const signals = findSignals(emaShort, emaLong, macdLine, signalLine);
    const analysis = analyzeSignals(signals, 0.1, 0.3, data, ticker);
    
    document.getElementById('results').textContent += `=== ${ticker} ===\n` + analysis + '\n\n';

    if (analysis.includes('–°–∏–≥–Ω–∞–ª')) {
      sendToTelegram(`üìà –ù–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –ø–æ ${ticker}\n\n` + analysis);
    }
  }

  document.getElementById('status').textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω.';
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ Python-—Å–µ—Ä–≤–µ—Ä
function sendToTelegram(message) {
  const url = `http://localhost:5000/send?message=${encodeURIComponent(message)}`;
  fetch(url).catch(err => console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', err));
}
</script>
</body>
</html>
