<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Простой свечной график SBER</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #buttons { margin-bottom: 10px; }
    button { margin-right: 10px; padding: 8px 15px; }
  </style>
</head>
<body>

  <h3>Свечной график SBER (день / час)</h3>

  <div id="buttons">
    <button onclick="loadChart(24)">День</button>
    <button onclick="loadChart(60)">Час</button>
  </div>

  <canvas id="chart" width="900" height="400"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.4.0/dist/chartjs-chart-financial.min.js"></script>

  <script>
    const ctx = document.getElementById('chart').getContext('2d');
    let chart = null;

    function formatDate(d) {
      return d.toISOString().split('T')[0];
    }

    async function fetchData(interval) {
      const fromDate = '2021-01-01';
      const toDate = formatDate(new Date());

      const url = `https://iss.moex.com/iss/engines/stock/markets/shares/boards/TQBR/securities/SBER/candles.json?interval=${interval}&from=${fromDate}&till=${toDate}&sort_order=asc&limit=1000`;

      const res = await fetch(url);
      const json = await res.json();

      if (!json.candles || !json.candles.data) return [];

      const cols = json.candles.columns;
      const data = json.candles.data;

      const idxBegin = cols.indexOf('begin');
      const idxOpen = cols.indexOf('open');
      const idxHigh = cols.indexOf('high');
      const idxLow = cols.indexOf('low');
      const idxClose = cols.indexOf('close');

      return data.map(row => ({
        x: new Date(row[idxBegin]),
        o: row[idxOpen],
        h: row[idxHigh],
        l: row[idxLow],
        c: row[idxClose]
      }));
    }

    async function loadChart(interval) {
      const data = await fetchData(interval);

      if(chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: interval === 24 ? 'Дневной график' : 'Часовой график',
            data: data,
            color: {
              up: '#0f0',
              down: '#f00',
              unchanged: '#999'
            }
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: interval === 24 ? 'day' : 'hour'
              }
            },
            y: {
              beginAtZero: false
            }
          }
        }
      });
    }

    // По умолчанию загружаем дневной график
    loadChart(24);
  </script>
</body>
</html>
