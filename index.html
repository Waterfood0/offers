<!DOCTYPE html><html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Активные сигналы по акциям (EMA + MACD)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 10px; }
    button { margin: 5px; padding: 7px 14px; cursor: pointer; }
    .section { margin-top: 20px; }
    .card { background: #f1f1f1; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
    .signal { white-space: pre-wrap; font-size: 14px; }
    h2, h3 { margin-bottom: 5px; }
  </style>
</head>
<body><h2>Активные сигналы по всем акциям</h2>
<div id="all-signals"></div><h2>Выбор акций</h2>
<div>
  <button onclick="showTickerSignals('SBER')">SBER</button>
  <button onclick="showTickerSignals('GAZP')">GAZP</button>
  <button onclick="showTickerSignals('LKOH')">LKOH</button>
  <button onclick="showTickerSignals('MGNT')">MGNT</button>
  <button onclick="showTickerSignals('YNDX')">YNDX</button>
</div><div class="section">
  <h3>Сигналы выбранной акции</h3>
  <div id="ticker-signals"></div>
</div><script>
const tickers = ['SBER', 'GAZP', 'LKOH', 'MGNT', 'YNDX'];
let allSignalsData = {}; // по тикерам

function getCurrentMonthStart() {
  const now = new Date();
  return new Date(now.getFullYear(), now.getMonth(), 1);
}

function filterCurrentMonth(signals, data) {
  const start = getCurrentMonthStart();
  return signals.filter(s => {
    const signalDate = data[s.index]?.date;
    return signalDate && signalDate >= start && !s.closed;
  });
}

function findSignals(data) {
  const emaShort = calculateEMA(data, 5);
  const emaLong = calculateEMA(data, 15);
  const { macdLine, signalLine } = calculateMACD(data);
  const signals = [];
  for (let i = 1; i < data.length; i++) {
    const emaCrossUp = emaShort[i - 1] < emaLong[i - 1] && emaShort[i] > emaLong[i];
    const emaCrossDown = emaShort[i - 1] > emaLong[i - 1] && emaShort[i] < emaLong[i];
    const macdCrossUp = macdLine[i - 1] < signalLine[i - 1] && macdLine[i] > signalLine[i];
    const macdCrossDown = macdLine[i - 1] > signalLine[i - 1] && macdLine[i] < signalLine[i];
    if (emaCrossUp || macdCrossUp) signals.push({ index: i, type: 'buy', closed: false });
    else if (emaCrossDown || macdCrossDown) signals.push({ index: i, type: 'sell', closed: false });
  }
  return signals;
}

function calculateEMA(data, period) {
  const k = 2 / (period + 1);
  const ema = [];
  let prev = data[0].close;
  for (let i = 0; i < data.length; i++) {
    prev = data[i].close * k + prev * (1 - k);
    ema.push(prev);
  }
  return ema;
}

function calculateMACD(data, fast = 6, slow = 13, signal = 9) {
  const fastEMA = calculateEMA(data, fast);
  const slowEMA = calculateEMA(data, slow);
  const macd = fastEMA.map((val, i) => val - slowEMA[i]);
  const signalLine = calculateEMA(macd.map(v => ({ close: v })), signal);
  const histogram = macd.map((val, i) => val - signalLine[i]);
  return { macdLine: macd, signalLine, histogram };
}

function signalToText(signal, data, ticker) {
  const d = data[signal.index];
  return `Тикер: ${ticker}\nДата входа: ${d.date.toISOString().slice(0,10)}\nЦена: ${d.close.toFixed(2)}\nТип сигнала: ${signal.type.toUpperCase()}\n`;
}

async function loadDataForTicker(ticker) {
  const from = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().slice(0, 10);
  const url = `https://iss.moex.com/iss/engines/stock/markets/shares/boards/TQBR/securities/${ticker}/candles.json?interval=60&from=${from}&limit=1000`;
  try {
    const res = await fetch(url);
    const json = await res.json();
    const cols = json.candles.columns;
    const data = json.candles.data.map(row => {
      const obj = {};
      cols.forEach((key, i) => obj[key] = row[i]);
      return {
        date: new Date(obj.begin),
        open: obj.open,
        high: obj.high,
        low: obj.low,
        close: obj.close,
        volume: obj.volume
      };
    });
    const signals = findSignals(data);
    const filtered = filterCurrentMonth(signals, data);
    allSignalsData[ticker] = { data, signals: filtered };
  } catch (e) {
    console.error(`Ошибка загрузки ${ticker}`, e);
  }
}

function renderAllSignals() {
  const container = document.getElementById('all-signals');
  container.innerHTML = '';
  for (const ticker of tickers) {
    const block = document.createElement('div');
    block.className = 'card';
    const signals = allSignalsData[ticker]?.signals || [];
    if (signals.length === 0) continue;
    block.innerHTML = `<strong>${ticker}</strong><br>` + signals.map(s => signalToText(s, allSignalsData[ticker].data, ticker)).join('\n')
      .replace(/\n/g, '<br>');
    container.appendChild(block);
  }
}

function showTickerSignals(ticker) {
  const container = document.getElementById('ticker-signals');
  container.innerHTML = '';
  const tickerData = allSignalsData[ticker];
  if (!tickerData || tickerData.signals.length === 0) {
    container.innerHTML = 'Нет сигналов для ' + ticker;
    return;
  }
  const signals = tickerData.signals.slice(-3).reverse();
  container.innerHTML = signals.map(s => '<div class="card signal">' + signalToText(s, tickerData.data, ticker).replace(/\n/g, '<br>') + '</div>').join('');
}

async function loadAll() {
  await Promise.all(tickers.map(t => loadDataForTicker(t)));
  renderAllSignals();
}

loadAll();
setInterval(loadAll, 60000); // автообновление каждую минуту
</script></body>
</html>
