<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Свечной график SBER (2021-2025)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    button { margin-right: 10px; padding: 8px 15px; cursor: pointer; }
    #status { margin-bottom: 10px; }
  </style>
</head>
<body>

  <h2>Свечной график SBER (2021-2025)</h2>

  <div>
    <button onclick="loadAndDraw(24)">Дневные</button>
    <button onclick="loadAndDraw(60)">Часовые</button>
  </div>

  <p id="status">Нажмите кнопку для загрузки и построения графика</p>

  <canvas id="chart" width="900" height="500"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.4.0/dist/chartjs-chart-financial.min.js"></script>

  <script>
    const ctx = document.getElementById('chart').getContext('2d');
    const status = document.getElementById('status');
    let chart = null;

    const years = [2021, 2022, 2023, 2024, 2025];

    async function fetchYearData(ticker, interval, year) {
      const from = `${year}-01-01`;
      const till = `${year}-12-31`;

      const url = `https://iss.moex.com/iss/engines/stock/markets/shares/boards/TQBR/securities/${ticker}/candles.json?interval=${interval}&from=${from}&till=${till}&sort_order=asc&limit=1000`;

      try {
        const res = await fetch(url);
        const json = await res.json();
        if (!json.candles || !json.candles.data) return [];

        const cols = json.candles.columns;
        const data = json.candles.data;

        const dateIdx = cols.indexOf('begin');
        const openIdx = cols.indexOf('open');
        const highIdx = cols.indexOf('high');
        const lowIdx = cols.indexOf('low');
        const closeIdx = cols.indexOf('close');

        return data.map(row => ({
          x: new Date(row[dateIdx]),
          o: row[openIdx],
          h: row[highIdx],
          l: row[lowIdx],
          c: row[closeIdx]
        }));
      } catch(e) {
        console.error(`Ошибка загрузки данных за ${year}`, e);
        return [];
      }
    }

    async function loadAndDraw(interval) {
      status.textContent = 'Загрузка данных... Пожалуйста, подождите.';
      let allData = [];

      for (const year of years) {
        status.textContent = `Загрузка данных за ${year}...`;
        const yearData = await fetchYearData('SBER', interval, year);
        allData = allData.concat(yearData);
      }

      status.textContent = `Загрузка завершена. Записей: ${allData.length}. Строим график...`;

      if (chart) {
        chart.destroy();
      }

      chart = new Chart(ctx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: interval === 24 ? 'Дневные свечи' : 'Часовые свечи',
            data: allData,
            color: {
              up: '#4caf50',
              down: '#f44336',
              unchanged: '#999'
            }
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: interval === 24 ? 'day' : 'hour',
                tooltipFormat: 'dd MMM yyyy HH:mm',
                displayFormats: {
                  day: 'dd MMM yyyy',
                  hour: 'dd MMM HH:mm'
                }
              },
              title: { display: true, text: 'Дата' }
            },
            y: {
              beginAtZero: false,
              title: { display: true, text: 'Цена (₽)' }
            }
          },
          plugins: {
            legend: { display: true }
          }
        }
      });

      status.textContent = `График построен (${interval === 24 ? 'дневные' : 'часовые'} свечи).`;
    }
  </script>

</body>
</html>
